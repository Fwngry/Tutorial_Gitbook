>  原文地址 [blog.csdn.net](https://blog.csdn.net/haiross/article/details/39157885)

理解 inode
========



## 一、索引节点 inode

[inode](http://en.wikipedia.org/wiki/Inode) 是一个重要概念，是理解 Unix/Linux 文件系统和硬盘储存的基础。

我觉得，理解 inode，不仅有助于提高系统操作水平，还有助于体会 Unix 设计哲学，即如何把底层的复杂性抽象成一个简单概念，从而大大简化用户接口。

理解 inode，要从文件储存说起。

文件储存在硬盘上，硬盘的最小存储单位叫做 "扇区"（Sector）。每个扇区储存 512 字节（相当于 0.5KB）。

操作系统读取硬盘的时候，不会一个个扇区地读取，这样效率太低，而是一次性连续读取多个扇区，即一次性读取一个 "块"（block）。这种由多个扇区组成的 "块"，是文件存取的最小单位。

"块" 的大小，最常见的是 4KB，即连续八个 sector 组成一个 block。

文件数据都储存在 "块" 中，那么很显然，我们还必须找到一个地方储存文件的元信息，比如文件的创建者、文件的创建日期、文件的大小等等。这种储存文件元信息的区域就叫做 inode，中文译名为 "索引节点"(inode)。

每一个文件都有对应的 inode，里面包含了与该文件有关的一些信息。

**二、inode 的内容**

inode 包含文件的元信息，具体来说有以下内容：

> 　　* 文件的字节数
> 
> 　　* 文件拥有者的 User ID
> 
> 　　* 文件的 Group ID
> 
> 　　* 文件的读、写、执行权限
> 
> 　　* 文件的时间戳，共有三个：ctime 指 inode 上一次变动的时间，mtime 指文件内容上一次变动的时间，atime 指文件上一次打开的时间。
> 
> 　　* 链接数，即有多少文件名指向这个 inode
> 
> 　　* 文件数据 block 的位置

可以用 stat 命令，查看某个文件的 inode 信息：

> stat example.txt

总之，除了文件名以外的所有文件信息，都存在 inode 之中。至于为什么没有文件名，下文会有详细解释。

**三、inode 的大小**

inode 也会消耗硬盘空间，所以硬盘格式化的时候，操作系统自动将硬盘分成两个区域。1⃣️一个是数据区，存放文件数据；2⃣️另一个是 inode 区（inode table），存放 inode 所包含的信息。inode 节点的总数，在格式化时就给定。

每个 inode 节点的大小，一般是 128 字节或 256 字节。一般是每 1KB 或每 2KB 就设置一个 inode。假定在一块 1GB 的硬盘中，每个 inode 节点的大小为 128 字节，每 1KB 就设置一个 inode，那么 inode table 的大小就会达到 128MB，占整块硬盘的 （1:8）。

查看每个硬盘分区的 inode 总数和已经使用的数量，可以使用 df 命令。

> df -i

查看每个 inode 节点的大小，可以用如下命令：

> sudo dumpe2fs -h /dev/hda | grep "Inode size"

由于每个文件都必须有一个 inode，因此有可能发生 inode 已经用光，但是硬盘还未存满的情况。这时，就无法在硬盘上创建新文件。（inode>file_num）

**四、inode 号码**

每个 inode 都有一个号码，操作系统用 inode 号码来识别不同的文件。

这里值得重复一遍，Unix/Linux 系统内部不使用文件名，而使用 inode 号码来识别文件。对于系统来说，文件名只是 inode 号码便于识别的别称或者绰号。

表面上，用户通过文件名，打开文件。实际上，系统内部这个过程分成三步：首先，系统找到这个文件名对应的 inode 号码；其次，通过 inode 号码，获取 inode 信息；最后，根据 inode 信息，找到文件数据所在的 block，读出数据。

使用 ls -i 命令，可以看到文件名对应的 inode 号码：

> ls -i example.txt

## 二、目录文件

Unix/Linux 系统中，目录（directory）也是一种文件。打开目录，实际上就是打开目录文件。

目录文件的结构非常简单，就是一系列目录项（dirent）的列表。**每个目录项，由两部分组成：所包含文件的文件名，以及该文件名对应的 inode 号码。**

ls 命令只列出目录文件中的所有文件名：

> ls /etc

ls -i 命令列出整个目录文件，即文件名和 inode 号码：

> ls -i /etc

如果要查看文件的详细信息，就必须根据 inode 号码，访问 inode 节点，读取信息。ls -l 命令列出文件的详细信息。

> ls -l /etc

理解了上面这些知识，就能理解目录的权限。目录文件的读权限（r）和写权限（w），都是针对目录文件本身（即不同用户能以什么权限访问操作对该目录文件，例如这里不同用户对 tmp 目录文件（d 可以查出 tmp 是目录文件，d 表示 directory，即目录）分别为 rwxr-xr-x，第一组的三个字符，即 rwx，表示文件拥有者用户的对该文件的读写权限，第二组的三个字符，即 r-x，表示文件拥有者用户所在的用户组里的其他用户对该文件的读写权限，第三组的三个字符，即 r-x，表示文件拥有者用户所在的用户组以外的用户对该文件的读写权限。一个某个用户下运行的进程访问操作该目录文件只能以该用户所具有的对该目录文件的权限进行操作）。

由于目录文件内只有文件名和 inode 号码，所以如果只有读权限，只能获取文件名，无法获取其他信息，因为其他信息都储存在 inode 节点中，而读取 inode 节点内的信息需要目录文件的执行权限（x）。

## 三、硬链接

一般情况下，文件名和 inode 号码是 "一一对应" 关系，每个 inode 号码对应一个文件名。

但是，Unix/Linux 系统允许，<u>多个文件名指向同一个 inode 号码。</u>

**这意味着，可以用不同的文件名访问同样的内容；对文件内容进行修改，会影响到所有文件名；但是，删除一个文件名，不影响另一个文件名的访问。这种情况就被称为 "硬链接"（hard link）。**

ln 命令可以创建硬链接：

> 　　ln 源文件 目标文件

运行上面这条命令以后，源文件与目标文件的 inode 号码相同，都指向同一个 inode。**inode 信息中有一项叫做 "链接数"，记录指向该 inode 的文件名总数，**这时就会增加 1。

**反过来，删除一个文件名，就会使得 inode 节点中的 "链接数" 减 1。当这个值减到 0，表明没有文件名指向这个 inode，系统就会回收这个 inode 号码，以及其所对应 block 区域。**

这里顺便说一下目录文件的 "链接数"。创建目录时，默认会生成两个目录项："." 和 ".."。前者的 inode 号码就是当前目录的 inode 号码，等同于当前目录的 "硬链接"；后者的 inode 号码就是当前目录的父目录的 inode 号码，等同于父目录的 "硬链接"。所以，任何一个目录的 "硬链接" 总数，总是等于 2（某一目录的目录名和该目录的当前目录名）~加上它的子目录总数（含隐藏目录）。（**因为 inode 信息中有一项叫做 "链接数"，记录指向该 inode 的文件名总数**）~

**七、软链接**

除了硬链接以外，还有一种特殊情况。

文件 A 和文件 B 的 inode 号码虽然不一样，但是文件 A 的内容是文件 B 的路径。读取文件 A 时，系统会自动将访问者导向文件 B。因此，无论打开哪一个文件，最终读取的都是文件 B。这时，文件 A 就称为文件 B 的 "软链接"（soft link）或者 " 符号链接（symbolic link）。

这意味着，文件 A 依赖于文件 B 而存在，如果删除了文件 B，打开文件 A 就会报错："No such file or directory"。这是软链接与硬链接最大的不同：文件 A 指向文件 B 的文件名，而不是文件 B 的 inode 号码，文件 B 的 inode"链接数" 不会因此发生变化。

ln -s 命令可以创建软链接。

> 　　ln -s 源文文件或目录 目标文件或目录

**八、inode 的特殊作用**

由于 inode 号码与文件名分离，这种机制导致了一些 Unix/Linux 系统特有的现象。

　　1. 有时，文件名包含特殊字符，无法正常删除。这时，直接删除 inode 节点，就能起到删除文件的作用。

　　2. 移动文件或重命名文件，只是改变文件名，不影响 inode 号码。

　　3. 一个文件打开并运行以后，系统就以 inode 号码来识别这个文件，不再考虑文件名。因此，通常来说，系统无法从 inode 号码得知文件名（无法反推）。

第 3 点使得软件更新变得简单，可以在不关闭软件的情况下进行更新，不需要重启：识别到运行中的文件，系统通过 inode 号码而不通过文件名；更新的时候，新版文件以同样的文件名，生成一个新的 inode，不会影响到运行中的文件。等到下一次运行这个软件的时候，文件名就自动指向新版文件，旧版文件的 inode 则被回收。

**附加：**

二、硬链接和软链接 

其中每个 dentry 都有一个唯一的 inode，而每个 inode 则可能有多个 dentry，这种情况是由 ln 硬链接产生的。****

硬链接：其实就是同一个文件具有多个别名，具有相同 inode，而 dentry 不同。

              1. 文件具有相同的 inode 和 data block；

              2. 只能对已存在的文件进行创建；

              3. 不同交叉文件系统进行硬链接的创建

              4. 不能对目录进行创建，只能对文件创建硬链接

              5. 删除一个硬链接并不影响其他具有相同 inode 号的文件；

软链接：软链接具有自己的 inode，即具有自己的文件，只是这个文件中存放的内容是另一个文件的路径名。因此软链接具有自己的 inode 号以及用户数据块。

              1. 软链接有自己的文件属性及权限等；

              2. 软链接可以对不存在的文件或目录创建；

              3. 软链接可以交叉文件系统；

              4. 软链接可以对文件或目录创建；

              5. 创建软链接时，链接计数 i_nlink 不会增加；

              6. 删除软链接不会影响被指向的文件，但若指向的原文件被删除，则成死链接，但重新创建指向 的路径即可恢复为正常的软链接，只是源文件的内容可能变了。

[![](http://blog.chinaunix.net/attachment/201310/22/14518381_1382450227Hw5H.jpg)](http://blog.chinaunix.net/attachment/201310/22/14518381_1382450227wRRr.jpg)

http://blog.chinaunix.net/uid-14518381-id-3957854.html

****一、文件分配方式是索引分配**时的文件系统结构（粗略的说，是分区结构）：**

**一个文件系统里的文件分为目录文件和普通文件这两类。**

**如果文件分配方式是索引分配的话，则有索引节点这个概念的出现。**  

inode 也会消耗硬盘空间，所以硬盘格式化的时候，**操作系统自动将硬盘分成两个区域。一个是数据区，存放文件数据；另一个是 inode 区（inode table），**存放 inode 所包含的信息。  

每个 inode 节点的大小，一般是 128 字节或 256 字节。inode 节点的总数，在格式化时就给定，一般是每 1KB 或每 2KB 就设置一个 inode。假定在一块 1GB 的硬盘中，每个 inode 节点的大小为 128 字节，每 1KB 就设置一个 inode，那么 inode table 的大小就会达到 128MB，占整块硬盘的 12.8%。  

查看每个硬盘分区的 inode 总数和已经使用的数量，可以使用 df 命令：df -i


2、分区  

（1）分区结构  

    **分区（partition）在被 Linux 的文件系统（比如 ext2）格式化的时候，会分成 inode table 和 block table 两部分，且大小都是固定的。**该分区的所有 inode 都在 inode table 里，所有 block 都在 block table 里。


http://blog.csdn.net/poechant/article/details/7214926

**文件、目录、目录项、索引节点、超级块**  

如上的几个概念在磁盘中的位置关系如图 4 所示。

图 4. 磁盘与文件系统

![](http://www.ibm.com/developerworks/cn/linux/l-cn-vfs/4.jpg)

**目录块里存放的是一个个的 FCB（文件控制块，一个一般 128 字节）【FCB 就是目录文件存放的业务数据】，而数据块里存放的是普通文件的业务数据。普通文件由目录块里的一个 FCB 加上多个数据块组成，而目录文件由目录块里的一个 FCB 加上多个其他多个目录块组成。一个索引节点只能被一个文件（无论是目录文件，还是普通文件）所用，不能同时被其他文件所用。一个目录块里只能存放位于目录树里处于同级的文件（无论是目录文件，还是普通文件），所以一个根目录文件的 FCB 所在的目录块只能存放根目录文件的 FCB，与根目录文件同级的只有根目录文件自己。一个文件的 FCB 指向他的索引节点，他的索引节点指向该文件所拥有的块（如果该文件是目录文件，则该文件所拥有的块就是目录块；如果该文件是普通文件，则该文件所拥有的块就是数据块；）**  

http://www.ibm.com/developerworks/cn/linux/l-cn-vfs/  

[![](http://blog.chinaunix.net/attachment/201310/22/14518381_1382450226wr3B.jpg)](http://blog.chinaunix.net/attachment/201310/22/14518381_138245022444Np.jpg)

http://blog.chinaunix.net/uid-14518381-id-3957854.html

Superblock 是文件系统最基本的元数据，它定义了文件系统的类似、大小、状态，和其他元数据结构的信息（元数据的元数据）。Superblock 对于文件系统来说是非常关键的，因此对于每个文件系统它都冗余存储了多份。Superblock 对于文件系统来说是一个非常 “高等级” 的元数据结构。例如，如果 /var 分区的 Superblock 损坏了，那么 /var 分区将无法挂载。在这时候，一般会执行 fsck 来自动选择一份 Superblock 备份来替换损坏的 Superblock，并尝试修复文件系统。主 Superblock 存储在分区的 block 0 或者 block 1 中，而 Superblock 的备份则分散存储在文件系统的多组 block 中。当需要手工恢复时，我们可以使用 `dumpe2fs /dev/sda1 | grep -i superblock` 来查看 sda1 分区的 superblock 备份有哪一份是可用的。我们假设 dumpe2fs 输出了这样一行：`Backup superblock at 163840, Group descriptors at 163841-163841` ，通过这条信息，我们就可以尝试使用这个 superblock 备份：`/sbin/fsck.ext3 -b 163840 -B 1024 /dev/sda1`。请注意，这里我们假设 block 的大小为 1024 字节。

http://www.elmerzhang.com/2012/12/suerblock-inode-dentry-file-of-filesystem/  

=======================================

### 最后我们来做个总结：

1、一个 Inode 对应一个文件，而一个文件根据其大小，会占用多块 blocks。  
2、更为准确的来说，一个文件只对应一个 Inode。因为硬链接其实不是创建新文件，只是在 Directory 中写入了新的对应关系而已。  
3、当我们删除文件的时候，只是把 Inode 标记为可用，文件在 block 中的内容是没有被清除的，只有在有新的文件需要占用 block 的时候，才会被覆盖。

本文关键词：一天一点, 学习 Linux,Inode,ln,Inode 详解, 软链接, 硬链接

[Inode](http://www.opsers.org/tag/inode) [Inode 详解](http://www.opsers.org/tag/inode%e8%af%a6%e8%a7%a3) [ln](http://www.opsers.org/tag/ln) [一天一点](http://www.opsers.org/tag/%e4%b8%80%e5%a4%a9%e4%b8%80%e7%82%b9) [学习 Linux](http://www.opsers.org/tag/%e5%ad%a6%e4%b9%a0linux) [硬链接](http://www.opsers.org/tag/%e7%a1%ac%e9%93%be%e6%8e%a5) [软链接](http://www.opsers.org/tag/%e8%bd%af%e9%93%be%e6%8e%a5)